{% extends "admin/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Monitoring Dashboard - GrandVPS{% endblock %}

{% block content %}
<div id="content-main">
    <div class="module">
        <h1>GrandVPS Monitoring Dashboard</h1>

        <!-- System Overview -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <!-- Users -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
                <h3 style="margin-top: 0; color: #495057;">üë• Users</h3>
                <p style="font-size: 24px; font-weight: bold; margin: 10px 0;">{{ total_users }}</p>
                <p style="margin: 0; color: #6c757d;">Active: {{ active_users }} | New (30d): {{ new_users_30d }}</p>
            </div>

            <!-- VPS Instances -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
                <h3 style="margin-top: 0; color: #495057;">üñ•Ô∏è VPS Instances</h3>
                <p style="font-size: 24px; font-weight: bold; margin: 10px 0;">{{ total_vps }}</p>
                <p style="margin: 0; color: #6c757d;">Active: {{ active_vps }} | Pending: {{ pending_vps }} | Suspended: {{ suspended_vps }}</p>
            </div>

            <!-- Financial -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
                <h3 style="margin-top: 0; color: #495057;">üí∞ Financial</h3>
                <p style="font-size: 24px; font-weight: bold; margin: 10px 0;">{{ total_wallet_balance|floatformat:0|intcomma }} ÿ™ŸàŸÖÿßŸÜ</p>
                <p style="margin: 0; color: #6c757d;">Total Balance</p>
            </div>

            <!-- Billing -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
                <h3 style="margin-top: 0; color: #495057;">üìä Billing</h3>
                <p style="font-size: 24px; font-weight: bold; margin: 10px 0;">{{ total_billed|floatformat:0|intcomma }} ÿ™ŸàŸÖÿßŸÜ</p>
                <p style="margin: 0; color: #6c757d;">Total Billed | Invoices: {{ total_invoices }}</p>
            </div>
        </div>

        <!-- Alerts and Warnings -->
        {% if low_balance_users > 0 or old_pending_transactions > 0 or expiring_vps %}
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-bottom: 30px;">
            <h3 style="margin-top: 0; color: #856404;">‚ö†Ô∏è Alerts</h3>
            <ul style="margin: 0; padding-left: 20px;">
                {% if low_balance_users > 0 %}
                <li>{{ low_balance_users }} users have low wallet balance (< 10 ÿ™ŸàŸÖÿßŸÜ)</li>
                {% endif %}
                {% if old_pending_transactions > 0 %}
                <li>{{ old_pending_transactions }} transactions pending for more than 24 hours</li>
                {% endif %}
                {% if expiring_vps %}
                <li>{{ expiring_vps|length }} VPS instances expiring within 7 days</li>
                {% endif %}
            </ul>
        </div>
        {% endif %}

        <!-- Recent Activity Tables -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">

            <!-- Recent Users -->
            <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
                <h3 style="margin-top: 0;">Recent Users</h3>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <th style="text-align: left; padding: 8px;">Username</th>
                            <th style="text-align: left; padding: 8px;">Email</th>
                            <th style="text-align: left; padding: 8px;">Joined</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in recent_users %}
                        <tr style="border-bottom: 1px solid #f8f9fa;">
                            <td style="padding: 8px;">{{ user.username }}</td>
                            <td style="padding: 8px;">{{ user.email }}</td>
                            <td style="padding: 8px;">{{ user.date_joined|date:"M d, Y" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" style="padding: 8px; text-align: center; color: #6c757d;">No recent users</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Recent VPS -->
            <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
                <h3 style="margin-top: 0;">Recent VPS Instances</h3>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <th style="text-align: left; padding: 8px;">Name</th>
                            <th style="text-align: left; padding: 8px;">User</th>
                            <th style="text-align: left; padding: 8px;">Status</th>
                            <th style="text-align: left; padding: 8px;">Created</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for vps in recent_vps %}
                        <tr style="border-bottom: 1px solid #f8f9fa;">
                            <td style="padding: 8px;">{{ vps.name }}</td>
                            <td style="padding: 8px;">{{ vps.user.username }}</td>
                            <td style="padding: 8px;">
                                <span style="padding: 2px 8px; border-radius: 12px; font-size: 12px;
                                    {% if vps.status == 'active' %}background: #d4edda; color: #155724;
                                    {% elif vps.status == 'pending' %}background: #fff3cd; color: #856404;
                                    {% else %}background: #f8d7da; color: #721c24;{% endif %}">
                                    {{ vps.get_status_display }}
                                </span>
                            </td>
                            <td style="padding: 8px;">{{ vps.created_at|date:"M d, Y" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" style="padding: 8px; text-align: center; color: #6c757d;">No recent VPS instances</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; margin-top: 20px;">
            <h3 style="margin-top: 0;">Recent Transactions</h3>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <th style="text-align: left; padding: 8px;">User</th>
                        <th style="text-align: left; padding: 8px;">Type</th>
                        <th style="text-align: left; padding: 8px;">Amount</th>
                        <th style="text-align: left; padding: 8px;">Status</th>
                        <th style="text-align: left; padding: 8px;">Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in recent_transactions %}
                    <tr style="border-bottom: 1px solid #f8f9fa;">
                        <td style="padding: 8px;">{{ transaction.wallet.user.username }}</td>
                        <td style="padding: 8px;">{{ transaction.get_transaction_type_display }}</td>
                        <td style="padding: 8px;">{{ transaction.amount|floatformat:0|intcomma }} ÿ™ŸàŸÖÿßŸÜ</td>
                        <td style="padding: 8px;">
                            <span style="padding: 2px 8px; border-radius: 12px; font-size: 12px;
                                {% if transaction.status == 'completed' %}background: #d4edda; color: #155724;
                                {% elif transaction.status == 'pending' %}background: #fff3cd; color: #856404;
                                {% else %}background: #f8d7da; color: #721c24;{% endif %}">
                                {{ transaction.get_status_display }}
                            </span>
                        </td>
                        <td style="padding: 8px;">{{ transaction.created_at|date:"M d, H:i" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" style="padding: 8px; text-align: center; color: #6c757d;">No recent transactions</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Expiring VPS Alert -->
        {% if expiring_vps %}
        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; margin-top: 20px;">
            <h3 style="margin-top: 0; color: #dc3545;">‚ö†Ô∏è Expiring VPS Instances (Next 7 days)</h3>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <th style="text-align: left; padding: 8px;">Name</th>
                        <th style="text-align: left; padding: 8px;">User</th>
                        <th style="text-align: left; padding: 8px;">Expires</th>
                        <th style="text-align: left; padding: 8px;">Days Left</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vps in expiring_vps %}
                    <tr style="border-bottom: 1px solid #f8f9fa;">
                        <td style="padding: 8px;">{{ vps.name }}</td>
                        <td style="padding: 8px;">{{ vps.user.username }}</td>
                        <td style="padding: 8px;">{{ vps.expires_at|date:"M d, Y" }}</td>
                        <td style="padding: 8px;">
                            {% with days=vps.expires_at|timeuntil %}
                            <span style="color: {% if 'day' in days %}#dc3545{% else %}#ffc107{% endif %};">{{ days }}</span>
                            {% endwith %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}