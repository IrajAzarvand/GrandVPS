{% extends "main_template.html" %}
{% load static %}

{% block title %}پروفایل کاربری - سرویس ابری{% endblock %}

{% block content %}
<div class="profile-wrapper">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="user-profile">
                <div class="user-avatar">{{ user.get_full_name|slice:":2"|default:user.username|slice:":2"|upper }}</div>
                <div class="user-info">
                    <h3>{{ user.get_full_name|default:user.username }}</h3>
                    <p>کاربر سیستم</p>
                </div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <a href="{% url 'dashboard:dashboard' %}" class="nav-item">
                <i class="fas fa-tachometer-alt"></i>
                <span>داشبورد</span>
            </a>
            <a href="{% url 'vps:dashboard' %}" class="nav-item">
                <i class="fas fa-server"></i>
                <span>سرویس‌های من</span>
            </a>
            <a href="{% url 'billing:history' %}" class="nav-item">
                <i class="fas fa-file-invoice-dollar"></i>
                <span>صورتحساب‌ها</span>
            </a>
            <a href="{% url 'wallet:dashboard' %}" class="nav-item">
                <i class="fas fa-wallet"></i>
                <span>کیف پول</span>
            </a>
            <a href="{% url 'dashboard:profile' %}" class="nav-item active">
                <i class="fas fa-user-circle"></i>
                <span>پروفایل</span>
            </a>
            <a href="{% url 'dashboard:settings' %}" class="nav-item">
                <i class="fas fa-cog"></i>
                <span>تنظیمات</span>
            </a>
            <a href="#" class="nav-item">
                <i class="fas fa-headset"></i>
                <span>پشتیبانی</span>
            </a>
            <a href="{% url 'accounts:logout' %}" class="nav-item">
                <i class="fas fa-sign-out-alt"></i>
                <span>خروج</span>
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-left">
                <button class="mobile-menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div>
                    <h1>پروفایل کاربری</h1>
                    <p>مدیریت اطلاعات حساب کاربری</p>
                </div>
            </div>

            <div class="header-right">
                <div class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon toggle-icon" id="themeIcon"></i>
                    <span class="toggle-text" id="themeText">&nbsp;</span>
                </div>
            </div>
        </header>

        <!-- Profile Content -->
        <div class="dashboard-content">
            <div class="profile-content">
                <!-- Profile Sidebar -->
                <div class="profile-sidebar">
                    <div class="profile-avatar">
                        <div class="avatar-container">
                            <div class="avatar-img">{{ user.get_full_name|slice:":2"|default:user.username|slice:":2"|upper }}</div>
                            <div class="avatar-upload">
                                <i class="fas fa-camera"></i>
                            </div>
                        </div>
                        <h2 class="user-name">{{ user.get_full_name|default:user.username }}</h2>
                        <p class="user-role">کاربر سیستم</p>
                        <span class="account-status">حساب فعال</span>
                    </div>

                    <nav class="profile-menu">
                        <a href="#personal-info" class="menu-item active" onclick="showSection('personal-info')">
                            <i class="fas fa-user-edit"></i>
                            <span>اطلاعات شخصی</span>
                        </a>
                        <a href="#security" class="menu-item" onclick="showSection('security')">
                            <i class="fas fa-shield-alt"></i>
                            <span>امنیت</span>
                        </a>
                        <a href="#notifications" class="menu-item" onclick="showSection('notifications')">
                            <i class="fas fa-bell"></i>
                            <span>اعلان‌ها</span>
                        </a>
                    </nav>
                </div>

                <!-- Main Content -->
                <div class="profile-main">
                    <!-- Personal Information Section -->
                    <div id="personal-info-section" class="profile-section">
                        <h2 class="section-title">
                            <i class="fas fa-user-edit"></i>
                            اطلاعات شخصی
                        </h2>

                        <form method="post" id="profile-form">
                            {% csrf_token %}
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label" for="first_name">نام</label>
                                    <input type="text" id="first_name" name="first_name" class="form-input"
                                           value="{{ user.first_name }}" required>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="last_name">نام خانوادگی</label>
                                    <input type="text" id="last_name" name="last_name" class="form-input"
                                           value="{{ user.last_name }}" required>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="email">آدرس ایمیل</label>
                                    <input type="email" id="email" name="email" class="form-input"
                                           value="{{ user.email }}" required>
                                    <div class="form-hint">ایمیل شما برای ورود به حساب استفاده می‌شود</div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="phone">شماره تلفن</label>
                                    <input type="tel" id="phone" name="phone" class="form-input"
                                           value="{% if user.phone %}{{ user.phone }}{% endif %}">
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="username">نام کاربری</label>
                                    <input type="text" id="username" class="form-input"
                                           value="{{ user.username }}" disabled>
                                    <div class="form-hint">نام کاربری قابل تغییر نیست</div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="date_joined">تاریخ عضویت</label>
                                    <input type="text" class="form-input"
                                           value="{{ user.date_joined|date:'Y/m/d' }}" disabled>
                                </div>
                            </div>

                            <div class="action-buttons">
                                <button type="submit" class="btn btn-primary">ذخیره تغییرات</button>
                                <a href="{% url 'dashboard:dashboard' %}" class="btn btn-outline">بازگشت</a>
                            </div>
                        </form>
                    </div>

                    <!-- Security Section -->
                    <div id="security-section" class="profile-section" style="display: none;">
                        <h2 class="section-title">
                            <i class="fas fa-shield-alt"></i>
                            امنیت حساب
                        </h2>

                        <form method="post" id="security-form">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="change_password">

                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label" for="current_password">رمز عبور فعلی</label>
                                    <input type="password" id="current_password" name="current_password"
                                           class="form-input" required>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="new_password">رمز عبور جدید</label>
                                    <input type="password" id="new_password" name="new_password"
                                           class="form-input" required minlength="8">
                                    <div class="form-hint">رمز عبور باید حداقل ۸ کاراکتر باشد</div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="confirm_password">تکرار رمز عبور جدید</label>
                                    <input type="password" id="confirm_password" name="confirm_password"
                                           class="form-input" required minlength="8">
                                </div>
                            </div>

                            <div class="action-buttons">
                                <button type="submit" class="btn btn-primary">تغییر رمز عبور</button>
                                <button type="button" class="btn btn-outline" onclick="showSection('personal-info')">لغو</button>
                            </div>
                        </form>

                        <div class="security-info">
                            <div class="security-grid">
                                <div class="security-card">
                                    <div class="security-header">
                                        <div>
                                            <h3 class="security-title">آخرین ورود</h3>
                                            <p class="security-desc">آخرین فعالیت ورود به حساب</p>
                                        </div>
                                        <span class="security-status status-active">امن</span>
                                    </div>
                                    <div class="security-value">{{ user.last_login|date:'Y/m/d H:i' }}</div>
                                </div>

                                <div class="security-card">
                                    <div class="security-header">
                                        <div>
                                            <h3 class="security-title">وضعیت حساب</h3>
                                            <p class="security-desc">وضعیت امنیتی حساب کاربری</p>
                                        </div>
                                        <span class="security-status status-active">فعال</span>
                                    </div>
                                    <div class="security-value">حساب شما ایمن است</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notifications Section -->
                    <div id="notifications-section" class="profile-section" style="display: none;">
                        <h2 class="section-title">
                            <i class="fas fa-bell"></i>
                            تنظیمات اعلان‌ها
                        </h2>

                        <form method="post" id="notifications-form">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="update_notifications">

                            <div class="notifications-grid">
                                <div class="notification-item">
                                    <div class="notification-content">
                                        <h4>اعلان‌های صورتحساب</h4>
                                        <p>دریافت اعلان برای صورتحساب‌های جدید و سررسید پرداخت</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" name="billing_notifications" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>

                                <div class="notification-item">
                                    <div class="notification-content">
                                        <h4>اعلان‌های سرویس</h4>
                                        <p>دریافت اعلان برای تغییرات وضعیت سرویس‌ها</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" name="service_notifications" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>

                                <div class="notification-item">
                                    <div class="notification-content">
                                        <h4>اعلان‌های امنیتی</h4>
                                        <p>دریافت اعلان برای فعالیت‌های امنیتی حساب</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" name="security_notifications" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>

                                <div class="notification-item">
                                    <div class="notification-content">
                                        <h4>اعلان‌های بازاریابی</h4>
                                        <p>دریافت خبرنامه و پیشنهادات ویژه</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" name="marketing_notifications">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <div class="action-buttons">
                                <button type="submit" class="btn btn-primary">ذخیره تنظیمات</button>
                                <button type="button" class="btn btn-outline" onclick="showSection('personal-info')">لغو</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Profile Content Layout */
.profile-content {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 2rem;
}

.profile-sidebar {
    background: linear-gradient(145deg, rgba(30, 30, 46, 0.8) 0%, rgba(21, 21, 34, 0.8) 100%);
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(0, 170, 255, 0.15);
    backdrop-filter: blur(10px);
    height: fit-content;
}

.light-mode .profile-sidebar {
    background: var(--card-light);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--border-light);
}

.profile-main {
    background: linear-gradient(145deg, rgba(30, 30, 46, 0.8) 0%, rgba(21, 21, 34, 0.8) 100%);
    border-radius: 16px;
    padding: 2.5rem;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(0, 170, 255, 0.15);
    backdrop-filter: blur(10px);
}

.light-mode .profile-main {
    background: var(--card-light);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--border-light);
}

.profile-section {
    display: none;
}

.profile-section:first-child {
    display: block;
}

/* Form Styles */
.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--text-light);
    font-weight: 500;
}

.light-mode .form-label {
    color: var(--text-dark);
}

.form-input {
    width: 100%;
    padding: 12px 15px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: var(--text-light);
    font-size: 1rem;
    transition: all 0.3s ease;
}

.light-mode .form-input {
    background: rgba(0, 0, 0, 0.02);
    border: 1px solid var(--border-light);
    color: var(--text-dark);
}

.form-input:focus {
    outline: none;
    border-color: var(--electric-blue);
    box-shadow: 0 0 0 3px rgba(0, 170, 255, 0.2);
}

.form-input:disabled {
    background: rgba(255, 255, 255, 0.02);
    color: var(--text-muted);
    cursor: not-allowed;
}

.light-mode .form-input:disabled {
    background: rgba(0, 0, 0, 0.01);
    color: var(--text-gray);
}

.form-hint {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-top: 5px;
}

.light-mode .form-hint {
    color: var(--text-gray);
}

/* Security Info */
.security-info {
    margin-top: 2rem;
}

.security-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

.security-card {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 1.5rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.light-mode .security-card {
    background: rgba(0, 0, 0, 0.02);
    border: 1px solid var(--border-light);
}

.security-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.security-title {
    font-size: 1.1rem;
    color: var(--text-light);
    margin-bottom: 0.5rem;
}

.light-mode .security-title {
    color: var(--text-dark);
}

.security-desc {
    color: var(--text-muted);
    font-size: 0.9rem;
}

.light-mode .security-desc {
    color: var(--text-gray);
}

.security-value {
    color: var(--text-light);
    font-weight: 500;
}

.light-mode .security-value {
    color: var(--text-dark);
}

/* Notifications */
.notifications-grid {
    display: grid;
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.notification-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.light-mode .notification-item {
    background: rgba(0, 0, 0, 0.02);
    border: 1px solid var(--border-light);
}

.notification-content h4 {
    color: var(--text-light);
    margin-bottom: 0.5rem;
}

.light-mode .notification-content h4 {
    color: var(--text-dark);
}

.notification-content p {
    color: var(--text-muted);
    font-size: 0.9rem;
}

.light-mode .notification-content p {
    color: var(--text-gray);
}

/* Toggle Switch */
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255, 255, 255, 0.2);
    transition: 0.4s;
    border-radius: 24px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
}

input:checked + .toggle-slider {
    background-color: var(--neon-green);
}

input:checked + .toggle-slider:before {
    transform: translateX(26px);
}

/* Action Buttons */
.action-buttons {
    display: flex;
    gap: 15px;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.light-mode .action-buttons {
    border-top: 1px solid var(--border-light);
}

/* Responsive */
@media (max-width: 1024px) {
    .profile-content {
        grid-template-columns: 1fr;
    }

    .profile-sidebar {
        order: 2;
    }

    .profile-main {
        order: 1;
    }
}

@media (max-width: 768px) {
    .form-grid {
        grid-template-columns: 1fr;
    }

    .security-grid {
        grid-template-columns: 1fr;
    }

    .action-buttons {
        flex-direction: column;
    }
}
</style>

<script>
function showSection(sectionId) {
    // Hide all sections
    const sections = document.querySelectorAll('.profile-section');
    sections.forEach(section => section.style.display = 'none');

    // Show selected section
    const targetSection = document.getElementById(sectionId + '-section');
    if (targetSection) {
        targetSection.style.display = 'block';
    }

    // Update menu active state
    const menuItems = document.querySelectorAll('.menu-item');
    menuItems.forEach(item => item.classList.remove('active'));

    // Find and activate the clicked menu item
    const clickedItem = document.querySelector(`[onclick="showSection('${sectionId}')"]`);
    if (clickedItem) {
        clickedItem.classList.add('active');
    }
}

// Theme toggle functionality
document.addEventListener('DOMContentLoaded', function() {
    // Mobile menu toggle
    const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
    const sidebar = document.querySelector('.sidebar');

    if (mobileMenuToggle && sidebar) {
        mobileMenuToggle.addEventListener('click', function() {
            sidebar.classList.toggle('active');
        });

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(event) {
            if (window.innerWidth <= 1024) {
                if (!sidebar.contains(event.target) && !mobileMenuToggle.contains(event.target)) {
                    sidebar.classList.remove('active');
                }
            }
        });
    }

    // Theme toggle functionality
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const themeText = document.getElementById('themeText');

    if (themeToggle && themeIcon && themeText) {
        // Check for saved theme preference or default to dark
        const currentTheme = localStorage.getItem('theme') || 'dark';

        // Apply the saved theme on page load
        if (currentTheme === 'light') {
            document.body.classList.add('light-mode');
            themeIcon.classList.remove('fa-moon');
            themeIcon.classList.add('fa-sun');
            themeText.textContent = '';
        }

        // Toggle theme on button click
        themeToggle.addEventListener('click', function() {
            document.body.classList.toggle('light-mode');

            if (document.body.classList.contains('light-mode')) {
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
                themeText.textContent = '';
                localStorage.setItem('theme', 'light');
            } else {
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
                themeText.textContent = '';
                localStorage.setItem('theme', 'dark');
            }
        });
    }

    // Password confirmation validation
    const newPassword = document.getElementById('new_password');
    const confirmPassword = document.getElementById('confirm_password');

    if (newPassword && confirmPassword) {
        confirmPassword.addEventListener('input', function() {
            if (this.value !== newPassword.value) {
                this.setCustomValidity('رمز عبور و تکرار آن مطابقت ندارند');
            } else {
                this.setCustomValidity('');
            }
        });
    }
});
</script>
{% endblock %}